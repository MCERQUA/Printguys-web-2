# TASK T018: Add Order Status Updates

## OBJECTIVE
Create API endpoint for updating order status with notifications.

## PROJECT LOCATION
/home/nick/Nick/Printguys-AI/printguys-nextjs

## INSTRUCTIONS

1. Create status update API at /src/app/api/admin/orders/[id]/status/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { isAdmin } from '@/lib/auth'
import { sendEmail, emailTemplates } from '@/lib/email'

export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  try {
    // Verify admin
    const admin = await isAdmin()
    if (!admin) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { status, trackingNumber, carrier, notes } = await request.json()

    // Get current order
    const order = await prisma.order.findUnique({
      where: { id: params.id },
      include: { user: true },
    })

    if (!order) {
      return NextResponse.json({ error: 'Order not found' }, { status: 404 })
    }

    // Update order
    const updatedOrder = await prisma.order.update({
      where: { id: params.id },
      data: {
        status,
        trackingNumber: trackingNumber || order.trackingNumber,
        carrier: carrier || order.carrier,
        notes: notes ? `${order.notes}\n${new Date().toISOString()}: ${notes}` : order.notes,
        updatedAt: new Date(),
      },
    })

    // Send notifications based on status change
    const customerEmail = order.user?.email || order.guestEmail

    if (customerEmail) {
      if (status === 'shipped' && trackingNumber) {
        const template = emailTemplates.orderShipped(order, trackingNumber, carrier || 'Canada Post')
        await sendEmail({
          to: customerEmail,
          subject: template.subject,
          html: template.html,
        })
      } else if (status === 'delivered') {
        // Could send delivery confirmation email
      } else if (status === 'canceled') {
        // Send cancellation email
      }
    }

    return NextResponse.json({
      success: true,
      order: updatedOrder,
    })
  } catch (error) {
    console.error('Status update error:', error)
    return NextResponse.json({ error: 'Failed to update status' }, { status: 500 })
  }
}
```

2. Create bulk status update at /src/app/api/admin/orders/bulk-status/route.ts:
```typescript
import { NextRequest, NextResponse } from 'next/server'
import { prisma } from '@/lib/prisma'
import { isAdmin } from '@/lib/auth'

export async function PATCH(request: NextRequest) {
  try {
    const admin = await isAdmin()
    if (!admin) {
      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
    }

    const { orderIds, status } = await request.json()

    const result = await prisma.order.updateMany({
      where: { id: { in: orderIds } },
      data: { status, updatedAt: new Date() },
    })

    return NextResponse.json({
      success: true,
      updated: result.count,
    })
  } catch (error) {
    console.error('Bulk status update error:', error)
    return NextResponse.json({ error: 'Failed to update' }, { status: 500 })
  }
}
```

3. Add middleware protection for /api/admin/* routes

## OUTPUT
- Write results to: /home/nick/Nick/Printguys-AI/printguys-nextjs/z-code-outputs/agent7-T018.md
- End with "TASK_COMPLETED" if successful
