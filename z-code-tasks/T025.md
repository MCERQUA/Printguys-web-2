# TASK T025: Security Audit & Fixes

## OBJECTIVE
Review and fix security issues in the application.

## PROJECT LOCATION
/home/nick/Nick/Printguys-AI/printguys-nextjs

## INSTRUCTIONS

1. Run npm audit:
```bash
cd /home/nick/Nick/Printguys-AI/printguys-nextjs
npm audit
```

2. Fix vulnerabilities:
```bash
npm audit fix
# If needed: npm audit fix --force (use with caution)
```

3. Check for exposed secrets:
```bash
# Check .env files are gitignored
cat .gitignore | grep -E "\.env"

# Search for hardcoded secrets
grep -r "sk_test\|sk_live\|password\|secret\|api_key" --include="*.ts" --include="*.tsx" src/
```

4. Security headers - update middleware.ts:
```typescript
import { NextResponse } from 'next/server'
import type { NextRequest } from 'next/server'

export function middleware(request: NextRequest) {
  const response = NextResponse.next()

  // Security headers
  response.headers.set('X-Frame-Options', 'DENY')
  response.headers.set('X-Content-Type-Options', 'nosniff')
  response.headers.set('Referrer-Policy', 'strict-origin-when-cross-origin')
  response.headers.set('X-XSS-Protection', '1; mode=block')
  response.headers.set(
    'Permissions-Policy',
    'camera=(), microphone=(), geolocation=()'
  )

  // CSP (Content Security Policy) - adjust as needed
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com https://www.googletagmanager.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self'; connect-src 'self' https://api.stripe.com https://www.google-analytics.com; frame-src https://js.stripe.com https://hooks.stripe.com;"
  )

  return response
}
```

5. Input validation - ensure all APIs validate:
```typescript
import { z } from 'zod'

const contactSchema = z.object({
  name: z.string().min(1).max(100),
  email: z.string().email(),
  message: z.string().min(10).max(5000),
  phone: z.string().optional(),
})

// In API route:
const result = contactSchema.safeParse(body)
if (!result.success) {
  return NextResponse.json({ error: 'Invalid input' }, { status: 400 })
}
```

6. Rate limiting - add to sensitive endpoints:
```typescript
// Simple in-memory rate limiter (use Redis for production)
const rateLimit = new Map<string, { count: number; timestamp: number }>()

function checkRateLimit(ip: string, limit: number = 10, windowMs: number = 60000) {
  const now = Date.now()
  const record = rateLimit.get(ip)

  if (!record || now - record.timestamp > windowMs) {
    rateLimit.set(ip, { count: 1, timestamp: now })
    return true
  }

  if (record.count >= limit) {
    return false
  }

  record.count++
  return true
}

// In API:
const ip = request.headers.get('x-forwarded-for') || 'unknown'
if (!checkRateLimit(ip)) {
  return NextResponse.json({ error: 'Too many requests' }, { status: 429 })
}
```

7. CSRF protection (Clerk handles this, but verify):
- Check all state-changing operations use POST/PATCH/DELETE
- Verify Clerk middleware is properly configured

8. SQL Injection prevention:
- Prisma uses parameterized queries by default
- Verify no raw SQL with user input

9. XSS prevention:
- React escapes output by default
- Check for dangerouslySetInnerHTML usage
- Validate any user-generated content

10. Sensitive data exposure:
- Ensure API responses don't leak sensitive data
- Check error messages don't expose internals

## OUTPUT
- Write results to: /home/nick/Nick/Printguys-AI/printguys-nextjs/z-code-outputs/agent8-T025.md
- List all vulnerabilities found
- Document fixes applied
- End with "TASK_COMPLETED" if successful
